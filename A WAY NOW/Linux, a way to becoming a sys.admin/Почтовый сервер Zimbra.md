Минимально требуемая конфигурация:
4 ядра 8гб ОЗУ
*Zimbra поддеживате только Ubuntu20.04* 

1. Привязка сервера к домену, да, необходим домен для полноценной работы почтового сервера
Пока что добавляем A - запись сервера
Добавляем запись в /etc/hosts
Проверяем пингом, что всё настроилось 

2. Отключим службу systemd-resolved
systemctl disable systemd-resolved.service
- Откроем файл **/etc/resolv.conf** удалим всё содержимое и добавим **nameserver 8.8.8.8**, после чего обновим систему

3. Установка и распаковка
Можно брать версии прямо с сайта:
```
1  https://www.zimbra.com/downloads/zimbra-collaboration/

2  wget https://files.zimbra.com/downloads/8.8.15_GA/zcs-8.8.15_GA_4179.UBUNTU20_64.20211118033954.tgz

3  tar -xzvf zcs-8.8.15_GA_4179.UBUNTU20_64.20211118033954.tgz

4  ./install.sh
```
Подтверждаем всё и ждём установки
- Дожидаемся выхода некоторого меню с цифрами, жмём 7 и 4, устанавливаем пароль админа
- Выходим через "r" и поддтвеждаем всё через "a"
- В последнем подтвержеднии можно указать "N"
ждём окончания установки и перезапускаем сервис

4. Порты доступа Zimbra
Zimbra используем множество сервисов и порты для их доступа следующие 

Порты на прием почты снаружи:

25 - нешифрованный SMTP:

465 - SSL SMTP

587 - TLS SMTP
 
Порты для подключения почтовых клиентов:

110 - POP3

145 -IMAP

993- IMAP SSL

995 - POP3 SSL

Веб-клиент

443 - HTTPS

Управление:

***7071*** - панель управления сервером. Тут тоже HTTPS, но порт нестандартный.

Основной доступ через 7071, поэтому попадаем в веб интерфейс исключительно через https://[домен] or [ip] :7071
Логин - admin@[домен]
Пароль - [тот что указывали при установке]

5. Мультидоменный сервер
Сервер может использовать не один домен и сейчас будет показан процесс создание  ещё одного
Пункт настройка -> Создать домен 
вписываем имя домена 
имя узла общего пользования - хостнейм сервера
протокол общего пользования https
имя узла входящих сообщений smtp - хостнейм сервера
На следующей странице, выставить следующее подобие 
![[Pasted image 20230318201044.png]]

**GAL** - Global Address List. Это глобальная адресная книга (с емейлами клиентов) которой может пользоваться вся компания. Туда можно вписать как минимум сотрудников для упрощения поиска их контактов. *Под каждый домен создаётся собственная адресная книга*

6. Создание почтовых ящиков
Меню -> Управление -> Учётные записи -> Создать учётную запись

Красными отмечены обязательные поля, прокрутим вниз и добавим пароль

7. Почтовы веб-клиент
Переходим по https://[домен] or [ip] 
Входим по данным недавно созданного ящика
[user]@[домен]

8. Отправка тестового сообщения
Отправка весьма проста, уже сейчас сервер работает и будет отправлять сообщения, но будет отправлять их в папку спам, так как DNS кроме A-записи у нас ещё не настроен. 

9. Настройка DNS 
- **Добавим MX (Mail Exchange) - запись.**

Такая запись может быть в домене одна, а может быть и несколько. Если записей несколько, то выбор почтового сервера будет в соответствии с приоритетом сервера, указанном в записи. Будет выбран тот сервер который доступен и у которого вес ниже остальных.

Таким образом обеспечивается отказоустойчивость. Когда основной сервер ломается, то почта автоматически перенаправляется на резервный.

- Добавим **PTR - запись.**

PTR (обратная) запись предназначена для того, чтобы преобразовывать IP-адрес в имя.
Это один из первых механизмов защиты, который появился впоследствии.

- **SPF-запись**

Следующим этапом развития стал переход к выкладыванию в **DNS** текстовой информации с помощью записей типа **TXT**.Расшифровывается как Sender Policy Framework. Это **TXT**-запись указывающая на весь домен целиком - т.е. имя у нее будет ``@

А формат вот такой:
**v=spf1 +a +mx -all**

>**v=spf1** - это обязательная часть. Она одновременно указывает что это **SPF** запись и что версия протокола 1.
>**+a +mx -all** это условия по которым определяется легальность почтового сервера.
>+ разрешить
>- запретить
>**~** мягкий запрет (не отклонять, но складывать в папку спам)
>a - все хосты, имеющие **А**-записи могут легально слать почту с себя. Применяется для рассылки с сайтов - к примеру для отсылки паролей при регистрации
>**mx** - все хосты, имеющие **MX**-запись
>**all** - все хосты вообще. Делать +all значит дать спамерам зеленый свет
>Помимо этих условий можно еще и ip-адреса указывать
>**ip4:8.9.10.15**
>Если требуется наследовать настройки с другого домена, то это делается с помощью директивы include
>**include:_spf.yandex.net**

- **DKIM**

Вместо вывешивания списков легальных хостов, мы можем подписывать все письма асимметричным ключом. А ключ для проверки подписи положим в **TXT**-запись в **DNS**. 

***Механизм работы **DKIM** такой:***

Сервер делает подпись для письма и добавляет ее в виде заголовка dkim в тело письма.
Помимо подписи добавляет еще и слово именуемое селектор.

Он нужен для того, чтобы можно было каждому почтовому серверу назначить свою пару ключей dkim.

Соответственно, раз сервер подписывает, то на нем хранится секретный ключ.

Публичный ключ размешается на **DNS**-сервере в виде **TXT**-записи вот такого вида:
```bash
селектор._domainkey IN TXT "v=DKIM1; g=*; k=rsa; t=y; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQChsSSxLchl5uZIus/B++LRrHFURBfD4wcHKVXw7XP2RMNeRBgetacfqkVU0g8HsMfzq8WwVuD6KdB1TDfRGKlP4Z7jI11RYwpCo8x4u+KHbPBM16cVUAfKk6UdQhLvwzr2NT5BMi2mLTuVuGFKQcx7ECtozpm7Xgsoi8C+9LbmIwIDAQAB"
```

В **zimbra** настройка **DKIM** не просто простая, а суперпростая
Переходи в пользователя Zimbra 
Генерация ключа происходит вот так:
```bash
/opt/zimbra/libexec/zmdkimkeyutil -a -d practice-host.dfsystems.ru
```

Данные которые нужно взять, чтобы вписать в настройки домена 
```bash
0A25834E-C5B3-11ED-80DD-6B0E7B7973E1._domainkey IN      TXT     ( "v=DKIM1; k=rsa; "
          "p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAq0TyF1MoK/UeePfkoVjE+FS847YBmIvpL22KoXuToWz420wWyjk280ZbRm5wGlGKT4sFoI7q76m5jFbQw8EvRjJSjsgbDiPSXGGtpTiAjXgyJOuvgf7TlawjuGJfyz1/9UCPI5yGf3Phv6eDF02rtNImxER7etKVr7fcuGh0fvxjOoMHvfhqmptlt2JtGlhAu7HPEjt+iLoXYv"
          "Q5t0jCsDdIynocHgHmk61E8RQ1GmGjmxKNec7G/6mfQ/AxY0G/ArwOhuKW4K5mSbJY6cf7Dl59F6bUCGWJMUWIxXvGm8x4k+M1X1vSPgF5ymn30ud/bPDYLsDGcHxgDkdwmFrGOQIDAQAB" )
```
После того как добавили TXT файл с настройками выше, проверить правильность можно следующим образом 
```bash
opendkim-testkey -d practice-host.dfsystems.ru -s 0A25834E-C5B3-11ED-80DD-6B0E7B7973E1 -x /opt/zimbra/conf/opendkim.conf
```

***Собственно это все. Как только opendkim-test подтвердит, что в DNS все настроено правильно, можно отсылать письма и они уже не будут падать в папку спам.***

Записей может быть несколько.
Просмотреть их можно вот такой командой:
```bash
/opt/zimbra/libexec/zmdkimkeyutil -d practice-host.dfsystems.ru -q
```

- **DMARC**

Это новый прибамбас. Появился пару лет назад. Тоже связан со спамом и называется "Политика проверки писем".
По сути с помощью этой записи мы частично управляем антиспамом на чужих серверах.
Схематично механизм выглядит так:
![[Pasted image 20230318204048.png]]

Выглядит запись как-то так:
```bash
_dmarc.practice-host.dfsystems.ru. 3600 IN TXT "v=DMARC1; p=none; sp=none; pct=100; fo=0; rua=mailto:admin@practice-host.dfsystems.ru"
```
Такая запись на домен должна быть одна.
_dmarc.practice-host.dfsystems.ru - это полный **fqdn** доменной записи. Не обязательно использовать так. Обычная короткая запись тоже будет работать.

**v=DMARC1** - обозначает версию формата записи. По аналогии с **spf** и **dkim**. Не исключено что тоже дальше первой версии не уйдет.

**p** — политика на домен. Может принимать следующее значение: none — ничего не делать; **quarantine** — отправить письмо в спам; **reject** — отбросить письмо.

**sp** — политика на субдомены домена. Имеет такие же значения, что и p.

**pct** — какой процент сообщений пойдет под правила. Т.е. можно делать выборку не 100% писем, а, например, 15% контрольных. 

На этом с **DNS** закончили.

Чтобы проверить свой или чужой домен на правильность настроек почты в DNS можно пользоваться сторонними инструментами.

Например - [https://mxtoolbox.com/](https://mxtoolbox.com/)

10. Борьба со спамом
Антиспам в зимбре сделан на базе **amavis** и **spamassasin**.

Обучается антиспам двумя способами.
1. Загрузкой новых баз извне (в нашем случае с серверов zimbra inc)
2. С помощью специального скрипта.

*С загрузкой свежих антиспамовых баз все достаточно просто.*
Нужно выполнить вот эти команды:
```bash
sudo su - zimbra -c "zmlocalconfig -e antispam_enable_rule_updates=true"
sudo su - zimbra -c "zmlocalconfig -e antispam_enable_restarts=true"
sudo su - zimbra -c "zmamavisdctl restart"
sudo su - zimbra -c "zmmtactl restart"
```
и свежие базы будут регулярно подтягиваться.

*С помощью скрипта* (самостоятельного обучения)

Устроено это обучение следующим образом. Есть программа, которая из примеров спама генерирует базу антиспама или модифицирует ее. Есть скрипт, с помощью которого забираются со спамом и скармливаются скрипту.
А в противовес этому скрипту, есть другой, в котором письма, ошибочно принятые за спам.

Все это в зимбре настроено и работает. Самому ничего исправлять не надо. Остается лишь слать письма на нужные ящики.

Адреса этих ящиков, были прописаны в главном меню при установке
![[Pasted image 20230319172945.png]]
**spam** - ящик для спама
**ham** - ящик для писем, которые ошибочно приняты за спам

***Следующий механизм защиты от спама - спамлисты.***

Этот способ не является хорошей практикой. Это скорее способ ленивых админов.

Суть этого метода в том, что есть некие организации, которые собирают жалобы на спамеров и составляют т.н. черные списки спамеров. Туда входят и домены и ip-адреса. И проверка писем на спам не доходит до анализа текста письма, а сразу на этапе установки соединения отсекаются члены черного списка.
И проверка писем на спам не доходит до анализа текста письма, а сразу на этапе установки соединения отсекаются члены черного списка.

Включаются черные списки вот так:
```bash
sudo su - zimbra -c 'zmprov mcf zimbraMtaRestriction "reject_rbl_client zen.spamhaus.org"'
```
Тут в команде указан список от SpamHaus. Он не единственный.


***Иногда будут возникать ситуации, когда надо какой-то почтовый адрес исключить из проверки на спам.***

Есть и такой механизм.
Открываем файл, всё также через пользователя Zimbra
```bash
/opt/zimbra/conf/amavisd.conf.in
```

В нём надо найти секцию с вот таким заголовком:
```bash
a hash-type lookup table (associative array)
```
Всем письмам на этапе проверки на спам выставляется рейтинг. Чем циферка рейтинга выше, тем больше подозрений на спам.

*Чтобы отправитель не попадал на твоем сервере в спам практически никогда, достаточно выставить в этом конфиге рейтинг -10.*

Применим изменения
```bash
sudo su - zimbra -c "zmamavisdctl stop && zmamavisdctl start"
```


11. ***Размер пересылаемого сообщения***
По умолчанию в зимбре он равен 10Мб.
Часто бывает так, что сотрудники шлют объемные письма с отчетами в pdf или фотографиями с объектов. И размер пересылаемого сообщения надо увеличить.

Делается это так
```bash
sudo su - zimbra -c "zmprov modifyConfig zimbraMtaMaxMessageSize 31457280"
sudo su - zimbra -c "postfix reload"
```
Размер задается в байтах. В примере 30Мб.

12. ***TLS-сертификат Let's Encrypt***

Установка необходимых утилит
```bash
apt install letsencrypt
apt install git socat -y
```
Для генерации сертификата потребуется поднимать веб-сервер на пару секунд. А это 80-й порт и требуются права рута. Поэтому работать будем от него.
```bash
cd /root
git clone https://github.com/Neilpang/acme.sh
cd acme.sh
./acme.sh --install
```
Скрипт не только установился, но и прописал себя в твой **crontab** для автообновления сертификатов.

Теперь сгенерируем сертификат.
```bash
/root/.acme.sh/acme.sh --issue --standalone -d practice-host.dfsystems.ru
```
Сертификаты лежат по пути 
```bash
/root/.acme.sh/practice-host.dfsystems.ru
```
Первым шагом копируем приватный ключ сертификата в правильную папку:
```bash
sudo cp /root/.acme.sh/practice-host.dfsystems.ru/practice-host.dfsystems.rukey /opt/zimbra/ssl/zimbra/commercial/commercial.key
```
Теперь попробуй установить сертификат в зимбру с помощью фирменной утилиты:
```bash
sudo su - zimbra -c "/opt/zimbra/bin/zmcertmgr deploycrt comm /root/.acme.sh/practice-host.dfsystems.ru/practice-host.dfsystems.ru.cer /root/.acme.sh/practice-host.dfsystems.ru/fullchain.cer"
```
***В случае платного сертфиката эта команда завершится успешно.
Однако у тебя скорее всего вылезла ошибка. Утилита не смогла установить подлинность сертификата.***
Все потому, что в файле **fullchain.cer** отсутствует один сертификат из цепочки.
Эта проблема легко решается, т.к. недостающий компонент можно скачать.
```bash
wget https://letsencrypt.org/certs/trustid-x3-root.pem.txt -O identrustX3.pem
```
Теперь добавим его в **fullchain.cer**
```bash
cat identrustX3.pem >> /root/.acme.sh/mail.voiceteam.ru/fullchain.cer
```
И вот после этого запускаем установку сертификата заново.
```bash
sudo su - zimbra -c "/opt/zimbra/bin/zmcertmgr deploycrt comm /root/.acme.sh/practice-host.dfsystems.ru/practice-host.dfsystems.ru.cer /root/.acme.sh/practice-host.dfsystems.ru/fullchain.cer"
```
После успешной установки сертификата надо перезапустить почтовую систему
```bash
systemctl restart zimbra
```
Теперь надо раз в 2 месяца выполнять эти три нехитрые команды для обновления сертификата в почтовом сервере.
**Но конечно это можно автоматизировать при помощи скрипта bash**




[[ssmtp (mail)]] [[DNS]] [[Linux]] 