# Теория Nginx
**Nginx** - это ***HTTP-сервер обратный прокси сервер***, почтовый прокси сервер. TCP/UDP прокси сервер общего назначения. Он проксирует запросы с 80 порта на нужные нам сервисы 
Принцип его работы прост, к нему прилетает запрос и он в зависимости от конфигурационного файла который задан, выполняет определённые действия. 
***Что он может выполнять?***
1. Отдать код ответа 
2. Перенаправить запрос куда-то в другое место (redirect) в осном используется 301 (перманентный редиректр) его используют когда страничка или ресурс переехал на постоянной основе в другое место, 302  редирект (временый)
   ![[Pasted image 20230204162724.png]]
3. Отдавать статический контент (самый простой тип информации) 
4. Проксировать запросы
***Термины***
Nginx состоит из модулей, которые мы настраиваем с помощью директив, которые прописываються в конфигурационном файле. 
	Директивы бывают **Простые** и **Блочные**
	# **Простые** 
	Состоит из имени параметров, парметры разделяются пробелами и в конце обязательно должна стоять ; 
	![[Pasted image 20230204163724.png]]
	# **Блочная**
	Состоит из имени, возможно параметров и дополнительного блока с набором дополнительных инструкций помещённый внутри фигурных скобок. ***Если внутри фигурных скобок можно создать другие директивы, то это называется контекстом***: main, server, http, server, location. 
	![[Pasted image 20230204164040.png]]
	В конекст main, то есть сам nginx.conf входят контекст events (сюда входят директивы влияющие на обработку соединений) и http (отвечате за обработку нашего запроса) контекст сервер находится в http. 
	Директиква Listen определяет то, что будет слушать наш сервер. 
	***Директива Location***

# Вопрос на собеседовании. Что происходит, после того как в адресной строк вводишь адрес сайта и нажимаешь Enter?!
***Из чего состоит URL?***
Протокол (http/https) - это способ общения с ресурсом у которого ты хочешь что-то попросить
Хост и за ним запрос 
***Что будет если ввёл URL, но не ввёл протокол?***
Браузер смотрит, есть ли этот адрес у него в списке ***HSTS (HTTP Script Transport Security) - механизм принудительно активирующий соединение через протокол HTTPS)***,  если сайт есть в этом списке, то он запускается под https, если нет то по http. **Чтобы попасть в этот список**, например в Nginx для этого нужно добавить команду в заголовок ответа сайта. ![[Pasted image 20230204170837.png]]
Чтобы отправить пакет на сервер браузеру необходимо определить его IP адрес, для этого существует DNS. Браузер ищет IP адрес в 3 местах 
![[Pasted image 20230204171758.png]]
Если тут ничего не обнаружилось, то браузер идёт за этой информацией наружу, на сетевой DNS сервер, это либо роутер либо DNS сервер провайдера и дальше по цепочке. 
![[Pasted image 20230204172320.png]]
После чего идёт в обратную сторону, это называется **рекурсия**

***Чтобы сделать запрос к серверу, необходимо создать защищённое соединение.***
Браузер отправляет Client Hello со своей версией TLS серверу -> Сервер отвечает Server Hello также с TLS, методом шифрования и публичным сертификатом сервиса. 
Клиент подтвержает сертификат сервиса с помощью своего списка сертификации.

***Для отправки http запроса, необходимо сформировать заголовок.***
Как минимум нужно отправить метод (GET - получение данных; POST - отправка данных; PUT - создание нового ресурса; DELETE - удаление данных;) при запросе используется метод GET дальшей URL. >GET /pavlenko HTTP/2. Следующей строкой отправляем указанный хост host:www.youtube.com . Host необходим для размещения нескольких сайтов на одном сервере.
**В общем** после того как запрос сформирован, он отправляет на транспортный уровень, где сервер и клиент установят гарантированное соединение с помощью TCP 

***Продолжение***
Для того чтобы поставить Nginx, нужно будет поставить базу данных MariaDB, грубо говоря это тот же MySQL, но более современная.
Ну все теперь мы готовы поставить Nginx + PHP-FPM + MySQL

**sudo apt install --no-install-recommends nginx mariadb-server php php-fpm php-zip php-mysql php-curl php-gd php-mbstring php-xml php-xmlrpc**

После установки нам надо установить пароль пользователю root в базу, т.к. по умолчанию он пустой. Так надо для безопасности.
**sudo mysql -u root**
**set password for 'root'@'localhost' = PASSWORD('ieyah7Aew6oom8ohsooghies');**
**exit;**

***После каждой установки программы необходимо проверять статус его работы*** 
И так же использовать Snapshot в VB

Проверим работу nginx и mariadb, если не запущено то запускаем.

Теперь необходимо настроить конфиг для работы с Wordpress 
**cd /etc/nginx/sites-available**

Скачаем файл 
**sudo wget http://distrib.sipteco.com/website.conf **

Отредактируем его 
**nano /etc/nginx/sites-available/website.conf**
После server_name пишем доменное имя или пока что ip-адресс виртуалки
Под server_name указываем путь до корня сайта 

Слинкуем наш конфиг из **sites-available** в директоию **sites-enabled**
**sudo ln -s /etc/nginx/sites-available/website.conf /etc/nginx/sites-enabled/website.conf**

Проверим всё ли правильно настроили 
**sudo nginx -t**

Перезапускаем Nginx (reload)

Создадим дирректорию командой
**sudo mkdir** **-p /var/www/ubuntu-wordpress.ru/**
и дадим права nginx читать этот файл
**sudo chown -R www-data:www-data /var/www/**

Теперь настройка PHP-FPM 
**cd /etc/php/8.1/fpm/pool.d/**
Удаляем и создаём новый конфиг 
**rm /etc/php/8.1/fpm/pool.d/www.conf**
**wget http://distrib.sipteco.com/ubuntu-wp.conf**

Проверяем всё ли окей (reload) (restart)

Cоздадим в каталоге тестовый файлик где у нас должен лежать сайт
**touch** **/var/www/ubuntu-wordpress.ru/index.php**
**nano /var/www/ubuntu-wordpress.ru/index.php**
Вставляем следующий код 
```
<?php

phpinfo();

phpinfo(INFO_MODULES);

?>
```

Подключаемся к mysql 
**mysql -u root -p**
password ***

Создаём базу данных для wordpress 
**create database wp_mysitedb;**

Создадим пользователя **wpuser1** с паролем samplepassword
**CREATE USER 'wpuser1'@'ip-address VB' IDENTIFIED BY 'samplepassword';**
**GRANT ALL PRIVILEGES ON wp_mysitedb. * TO 'wpuser1'@'ip-address VB';**
**FLUSH PRIVILEGES;**

Скачиваем архив с самим движком 
**cd /var/www/ubuntu-wordpress.ru/**
Скачаем в него архив с **wordpress**
**sudo wget https://ru.wordpress.org/latest-ru_RU.tar.gz**
**tar -xzvf latest-ru_RU.tar.gz**

Скопируем содержимое папки wordpress в каталог /var/www/ubuntu-wordpress.ru
**sudo cp -rp wordpress/* /var/www/ubuntu-wordpress.ru/**

Дадим nginx права на эту папку, чтобы он мог читать и исполнять то что в ней содержится
**chown -R www-data:www-data /var/www/ubuntu-wordpress.ru**

[[Linux]] 

#Linux #nginx #webserver 