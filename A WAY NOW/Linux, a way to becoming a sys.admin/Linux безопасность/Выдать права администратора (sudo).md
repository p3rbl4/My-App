Общая конфигурация sudo хранится в **/etc/sudoers**, а отдельные логические блоки хранятся в **/etc/sudoers.d**

Под каждого пользователя можно заводить отдельный файл в **/etc/sudoers.d**.

# ***Файл /etc/sudoers***

Те что начинаются с **Defaults** это настройки по-умолчанию. Они общие для всех пользователей.
А дальше идут записи вида
_пользователь и какие-то параметры_

_группа и какие-то параметры_

Тут описываются персональные разрешения. Эти разрешения можно выдавать за раз в одной строке, а можно разбить на несколько. Они все будут учтены.

```bash
Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"
```
Тут мы переопределяем системную переменную **PATH** для сеанса **sudo**.
В этой переменной задаются пути, по которым командный интерпретатор будет искать команду, которую ты ввел.
Есть возможность добавить в **PATH** своего сеанса отдельную папку, где будут программы одноименные со стандартными, но выполняющие другие действия. Тем самым сделать что-то неразрешенное так, чтобы в логах ничего подозрительного не было видно.
Так что задать все пути жестко идея хорошая.

```bash
Defaults requiretty
```

Тут сам параметр уже говорящий. Включаем необходимость реального сеанса через **tty**. Этот параметр отсекает запуск через **sudo** скриптов и приложений **CGI** (а это к примеру скрипты с веб-сайта).
Но при этом также не дает запускать через **sudo** команды прописанные в **cron**.

```bash
Defaults use_pty
```

Так уж повелось еще со времен мейнфреймов, что для консольного сеанса в **Linux** требуется устройство ввода - телетайп или **tty**. Сейчас **tty** как отдельного устройства уже нет, но в **Linux** они эмулируются с помощью специальных утилит. Во всех современных дистрибутивах их как минимум 12 и некоторые имеют свое определенное предназначение. К примеру на 8-м обычно висит графическая оболочка.
Т.к. **tty** у нас ограниченное количество, то для того, чтобы открывать множество консольных и не только сеансов (к примеру через **ssh** или консолька в окне графической оболочки) был сделан виртуальный **tty**. **Pseudo tty** или **pty**.

*Если мы включаем **use_pty**, то все что запущено через **sudo** будет запускаться только на псевдотерминале. А pty при завершении сеанса завершает свое существование вместе со всем запущенным*

```bash
Defaults timestamp_timeout=10
```

Для выполнения команд через **sudo** обычно пользователь должен ввести свой пароль. Это может раздражать. Есть возможность создавать сеанс пользователя **sudo**. Выполнив команду через **sudo** с вводом пароля мы открываем сеанс. И все время жизни сеанса повторно пароль больше не запрашвается.

Время жизни сеанса задается администратором сервера через конфиг **sudo**. Пользователь может повлиять на него только в сторону уменьшения. Командой

*sudo -k*

можно этот сеанс закончить раньше времени. После этой команды пароль снова будет запрошен. Опять один раз за временной промежуток.
А этот временной промежуток задается командой выше в минутах. Т.е. 10 там означает 10 минут.

>***Можно еще и следить за тем, кто что делает через sudo***

Для этого есть два параметра:

_**Defaults log_host, log_year, logfile="/var/log/sudo.log"**_

По умолчанию этот лог пишется в **syslog**. Так что мы просто аккумулируем записи в отдельный файл для удобства.

_**Defaults log_input, log_output**_

Этот параметр приказывает **sudo** записывать текст сеанса работы пользователя.
Этот лог записывается в папку **/var/log/sudo-io**

Там есть и лог команд и сообщения стандартных каналов ввода-вывода (**stdin, stderr, stdout**) и лог с **tty/pty**

>***Можно переопределить сообщение, которое выдается при неверном вводе пароля.***

_**Defaults badpass_message="Ах ты паскудник! Пароль забыл? Али и не знал никогда?"**_
Ругаться будет после каждого неверного ввода.

# Управление разрешениями для пользователей и групп

Общая схема написания правил такова
**users hosts = (runas) commands**

**runas** - от кого можно запускать команду

**hosts** - имя компьютера, к которому относится правило. Можно алиас. Можно текстовое имя (то что выдает команда hostname), либо **ip** адрес или подсеть

Пример:
**test1 ALL = (test2) NOPASSWD: /usr/bin/mc**

Тут мы пользователю **test1** на любом компьютере (ALL) разрешаем запустить **mc** от имени пользователя **test2** без ввода пароля ( тег **NOPASSWD:**)

>Есть такая удобная вещь как **User_Alias**

Здесь можно указать имя пользователя, либо перечислить имена пользователей через запятую.
Пример: 
```bash
User_Alias ADMIN = bobr, vitaly, eduard

User_Alias WEBMASTER = evgen

User_Alias BUH=alla, nata, birukova_s
```

А в **Cmnd_Alias** команды
**Во-первых** необходимо прописывать полный путь до команды. Узнать можно с помощью утилиты **which**
**Во-вторых** важна степень детализации. Можно просто прописать команду и тогда она будет доступна без ограничений. А можно прописать ее с определенными параметрами и тогда доступ будет только до команды именно с этими параметрами. С другой стороны можно указать путь к папке и тогда все исполняемые файлы в ней будут доступны к запуску.
Пример:
```bash
Cmnd_Alias POWEROFF = /sbin/halt, /sbin/reboot, /sbin/shutdown

Cmnd_Alias FW_SHOW = /sbin/iptables -L

Cmnd_Alias SERVICES = /etc/init.d/
```

**Host_Alias**

Тут указывается как имя компьютера, так и ip-адрес или подсеть. При этом, если маска не указана явно, то sudo ее додумает самостоятельно. Поэтому надо быть внимательным при заполнении. Особенно если есть подсети вида 10.5.4.0/24. **Sudo** автоматически подставит маску /8, что может открыть неплохую дырку в защите сервера.
Также надо иметь ввиду, если пишем в Host_Alias имя, то оно должно указывать на внешний ip, а не на loopback. И локально оно должно резольвиться.
```bash
Host_Alias BUH = buh1, buh2, anjela

Host_Alias LAN = 192.168.3.0/24
```


# Практика распределение прав 

Дано:
- **server** - единственный сервер в организации. 192.168.1.1
- **manager1** - компьютер менеджера Васи
- **manager2** - компьютер менеджера Пети
- **ingeneer** - компьютер сервис-инженера Артема
- **krevedko** - компьютер сисадмина Виталия
- **boss** - компьютер директора Геннадия
Нужно написать политику **sudo** чтобы соблюсти следующие условия:
1. Все имеют возможность выключать и перезагружать компьютеры
2. Все имеют возможность монтировать устройства (cdrom, флешка, переносной жесткий диск и т.д.)
3. Сисадмин может все.
4. Сервис-инженер в отсутствии сисадмина может перезагружать сервисы на сервере.
5. Босс бывший телефонист и любит иногда покрутить ip-телефонию.

- ***Пишем Alias's***
Определям пользвателей в группы:
**User_Alias USERS = vasya, petya, vitaly, artem, gena**
**User_Alias ADMINS = ingeneer, krevedko**

Теперь выделяем группы команд, которые будем раздавать группам.
**Cmnd_Alias POWEROFF = /sbin/shutdown,/sbin/reboot,/sbin/halt**

**Cmnd_Alias PHONE = /usr/sbin/asterisk -r, /usr/sbin/service asterisk restart, cat /var/log/asterisk/full.log, tail /var/log/asterisk/full.log**
**Cmnd_Alias SERVICES = /etc/init.d/**
**Cmnd_Alias MOUNTS = /sbin/mount,/sbin/fdisk**

Сетка:
**Host_Alias SERVER = 192.168.1.1**
**Host_Alias LAN = 192.168.1.0/24**

- ***Самана конфигурация выглядит вот так***
**USERS LAN, !SERVER = (ALL) NOPASSWD: POWEROFF, MOUNTS**

**ADMINS LAN = (ALL) NOPASSWD: SERVICES**

**director SERVER = (ALL) NOPASSWD: PHONE**

**krevedko ALL = (ALL) ALL**

[[Linux безопасность]] 
#Права #Безопасность
