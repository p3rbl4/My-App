Подсистема управления логическими томами, виртуальное блочное устройство

***Достоинства***
1. Можно сделать один раздел из нескольких жестких дисков (в юности у меня был компьютер, на котором был один раздел на 80Гб, собранный из 4-х жестких дисков объемом по 20Гб).

2. Можно создавать огромное количество разделов внутри тома **LVM**, а также в пару комманд (без всяких **partition magik**-ов) изменять размеры этих разделов.

3. **LVM** внутри себя умеет **RAID** 0,1,5 если очень хочется.

4. Есть механизм snapshot-ов. Это удобно для проведения резервного копирования без остановки сервиса.

Сама структура **LVM** несмотря на то что это уже виртуальное блочное устройство, делится еще внутри себя на 3 логические структуры:
1. **PV** (Physical Volume) - это раздел диска или целый диск, размеченный под **LVM**. Это базовая структура - на нее навешивается следующая структура:

2. **VG** (Volume Group) - это как раз та абстракция, которая собирает несколько физических дисков в один логический том. Логично, что она может содержать в себе несколько **PV**. Добавлять и удалять **PV** можно на лету. Никаких остановок сервисов и перезагрузок не потребуется.

3. **LV** (Logical Volume) - это то, что в обычной разметке мы называем разделом жесткого диска. Этот раздел мы форматируем в нужную файловую систему, монтируем и используем как привычный раздел на жестком диске.

***Создание lvm раздела***
Создал раздел **fdisk /dev/sdc**
Создаю Physical Volume **sudo pvcreate /dev/sdc2**
Далее Volume Group **vgcreate myvg2 /dev/sdc2**
Logical Volume: **lvcreate myvg2 -n mylv2 -l 100%FREE ** (или -n LV1 -L 2G VG1 )
И файловая система:
mkfs.ext4 /dev/myvg2/mylv2
Дальше подправил файл */etc/fstab*
Создал папку */mnt/mydata2** куда буду монтировать
И примонтировал **mount -a** 

Просматривать информацию обо всех PV, можно командой 
```bash
pvdisplay 
```

Создание разделов LV происходит при помощи следующей структуры
```bash
lvcreate -n LV_name -Lsize VG_name
```
Пример: 
lvcreate -n VM1 -L5G megastorage

И просмотр созданных разделов
```bash
lvdisplay
```

К слову о **Device Mapper**. Этот слой абстракции наложил свои лапы на то, как отображаются **Logical Volume** в системе.

Все **Logical Volume** можно увидеть в папке **/dev/mapper**

В то же время под каждую **Volume Group** создана отдельная папка в каталоге **/dev**

# Что можно делать с созданными LV?

Примонтировать 
```bash
mkfs.ext4 /dev/mapper/megastorage-AsteriskVM
mkdir /mnt/tmp1
mount /dev/mapper/megastorage-VM1 /mnt/tmp2
```
Удалить
```bash
lvremove /dev/megastorage/VM1
vgremove megastorage
```

Как можно расширить LV?
Допустим у нас заканчивается место на LV, которым мы пользуемся.

Первым делом мы подключаем новый диск создаём PV привычной командой 
Дальше выполняем расширение 
```bash
vgextend <VG_name> /dev/sdb1 (новый диск)
```
Расширить логический том LVM на весь доступный размер нового диска с помощью команды
```bash
lvextend -l +100%FREE <LV_name>
```
Расширить файловую систему, находящуюся на логическом томе, с помощью команды, соответствующей используемой файловой системе. Например, для расширения файловой системы ext4 можно выполнить команду
```bash
resize2fs /dev/mapper/vg01-lv01
```

# Диск **/dev/sdc** начал сбоить. Надо как-то аккуратно перетащить данные на новый диск - **/dev/sdd1**

В этой ситуации можно сделать следующее:

1. Подключить еще один **PV**

2. Переместить данные с /**dev/sdc** на **/dev/sdd1**

3. Выкинуть **/dev/sdc** из **VG**

>Перед действиями необходимо добавить новый диск в PV

Для начала добавляем **/dev/sdd1** в **megastorage**
```bash
vgextend megastorage /dev/sdd1
```
и подвинем данные на новый PV
```bash
pvmove /dev/sdc /dev/sdd1
```
А когда процесс завершится, то надо выполнить эту команду и сломанный PV выйдет из состава VolumeGroup и его можно будет демонтировать.
```bash
vgreduce megastorage /dev/sdc
```

***Как можно перепроверить что диск пуст?***

```bash
pvdisplay /dev/sdc
```
и в ее выводе нас интересует параметр **Allocated PE**. Если там **0**, то значит данных на нем нет.


# Snapshot

У LVM припятанные тузы в рукаве и один из них, это возможность создавать Snapshot без отключения сервисов.
Создаётся snapshot так:
```bash
lvcreate -L1G -s -n backup -p r /dev/megastorage/Test2
```
Структура команды: 
`-L1G` - опция, указывающая на желаемый размер создаваемого логического раздела. Здесь мы указываем 1 гигабайт
`-s` - опция, указывающая на создание снимка (snapshot) для созданного логического раздела
`-n backup` - опция, задающая имя создаваемому логическому разделу
`-p r` - опция, задающая приоритет создаваемому логическому разделу. Здесь мы указываем приоритет `r`, что означает "высокий" (high priority)
`/dev/megastorage/Test2` - это устройство, на котором будет создан логический раздел

Смонтируем его в **/mnt/tmp**
```bash
mount -o ro /dev/megastorage/backup /mnt/tmp
```
`-o ro` - опция, указывающая на режим монтирования "только для чтения" (read-only). Это означает, что данные на монтируемом разделе не могут быть изменены

*Скорость работы раздела, на который сделан снапшот заметно падает. Поэтому после завершения всех нужных операций желательно освободить раздел удалив снапшот.*
```bash
umount /mnt/tmp
lvremove /dev/megastorage/backup
```

Снапшот с раздела на котором работает с файлами высоконагруженная база данных может быть непригоден для корректного бэкапа. Дело в том, что мы ловим состояние диска где-то посередине ряда транзакций с несброшенными кэшами. Поэтому набора данных может быть некорректным.

**СУБД** при запуске с таким набором файлов решит, что сервер выключался по питанию и начнет восстановление. Часть данных при этом будет потеняна.

В такой ситуации придется все же потушить **СУБД**, потом сделать снапшот, а потом запускать. В этом случае мы будем копировать файлы с корректно записанными данными. А в этот момент **БД** будет во всю работать.
>Вообщем для бэкапа БД лучше использовать Дампы, как по стандарту

# Отключение VG для корректного демонтирования дисков

Сначала отмонтируем все тома
```bash
vgchange -an megastorage (VG_NAME)
```
При подключении этих же дисков к другому ПК, надо будет сделать
```bash
vgchange -ay
```
и **Volume Group** активируется и можно будет монтировать тома из нее.


***Источник*** : https://www.youtube.com/watch?v=wFHC3q_iYRY&t=319s 
[[Linux]] 
https://yodo.im/lvm

[[Linux]] [[Работа с жёстикими дисками разделы, монтирование]]

#Диски #raid #Работасдисками 